# 设备点巡检管理模块 – 详细页面设计文档
（面向 AI 的精确、无歧义需求说明）

> 本文档采用「一个页面 = 一份需求」的格式，所有字段、交互、校验、权限、数据源、异常分支、自动化规则全部显式列出，可直接用于后续 PRD 或 LLM 代码生成。

---

## 命名规范
| 前缀 | 含义 | 示例 |
|---|---|---|
| P_ | 页面 (Page) | P_Dashboard |
| D_ | 弹窗 (Dialog) | D_CreatePolicy |
| C_ | 组件 (Component) | C_Chart_CompletionRate |

---

## 全局约定
1. 所有页面均为 **B/S 单页应用**，URL 统一以 `/inspection/` 开头。
2. 权限粒度：功能级（按钮）+ 数据级（行）。
3. 接口前缀：`/api/inspection/`。
4. 单位换算：在服务端完成，前端仅展示换算后值与原始值（带单位）。
5. 消息推送：统一走 `NotificationService`，支持现场看板、声光、APP、企业微信、邮件，优先级可配置。

---

## 1. P_Dashboard – 点检效率分析仪表盘

### 1.1 URL
`/inspection/dashboard`

### 1.2 权限
| 角色 | 可见 | 备注 |
|---|---|---|
| 设备管理员 | ✅ | 全指标 |
| 班组长 | ✅ | 仅本班组数据 |
| 维修员 | ✅ | 仅异常相关 |
| 访客 | ❌ | 跳转 403 |

### 1.3 布局
- 顶部筛选区（C_FilterBar）
- 4 个 KPI 卡片（C_KpiCard）
- 2 个图表区（C_Chart_CompletionRate、C_Chart_AbnormalTrend）
- 1 个异常排行榜表格（C_Table_TopAbnormal）

### 1.4 筛选字段
| 字段 | 类型 | 默认值 | 数据源 | 备注 |
|---|---|---|---|---|
| 时间范围 | DateRangePicker | 近7天 | - | 最大跨度 90 天 |
| 线体 | MultiSelect | 全部 | `/api/inspection/lines` | - |
| 设备型号 | MultiSelect | 全部 | 级联线体 | - |
| 点检类型 | MultiSelect | 全部 | 枚举：设备检、开工检、品质检… |

### 1.5 KPI 卡片
| 名称 | 计算口径 | 刷新方式 |
|---|---|---|
| 任务完成率 | `已完成任务数 / 总任务数` | 筛选即刷新 |
| 准时率 | `准点完成任务数 / 已完成任务数` | - |
| 异常率 | `异常任务数 / 总任务数` | - |
| 平均处理时长 | `异常关闭时间 - 异常上报时间` 的平均值 | - |

### 1.6 图表
- **完成率趋势图**  
  X：日期；Y：百分比；支持分组（完成/准时）。
- **异常类型分布**  
  饼图，钻取到异常列表页。
- **排行榜**  
  列：设备编码、异常次数、最近异常时间、操作（跳异常页）。

### 1.7 交互
- 点击图表柱子 → 打开 D_FilteredTaskList，带入日期范围 + 状态。
- 排行榜行点击 → 打开 P_AbnormalityDetail。

---

## 2. P_PolicyConfig – 策略配置中心

### 2.1 URL
`/inspection/policy`

### 2.2 列表页
- 列：策略名称、适用场景、创建人、更新时间、状态（启用/停用）、操作（编辑、复制、删除）。
- 搜索：名称模糊、场景下拉、创建人。

### 2.3 新增/编辑 (D_PolicyEdit)
弹窗分 4 步：
| 步骤 | 字段 | 类型 | 校验 | 备注 |
|---|---|---|---|---|
| 基础信息 | 策略名称 | Input | 必填，≤30字符 | - |
| 基础信息 | 适用场景 | Radio | 必填 | 设备检/开工检/品质检 |
| 基础信息 | 描述 | TextArea | ≤200字符 | - |
| 表单权限 | 可见字段列表 | Transfer | 至少选 1 | 左侧全部字段源 |
| 表单权限 | 可编辑字段列表 | Transfer | 可见字段子集 | - |
| 检查对象 | 设备型号 | MultiSelect | - | 同步 MES |
| 检查对象 | 线体 | MultiSelect | - | - |
| 检查对象 | 生产工单 | MultiSelect | 仅开工检可见 | 调用 MES `/work-orders` |
| 规则配置 | 检查项目模板 | Select | 必填 | - |
| 规则配置 | 频率 | Select | 必填 | 天/周/月/班 |
| 规则配置 | 触发时机 | Checkbox | 至少选 1 | 工单下达/换产/定时 |
| 规则配置 | 单位换算 | Switch | - | 开/关，默认关 |

保存后 → 后端生成策略 ID，同时创建默认版本号 `v1`。

---

## 3. P_ItemTemplate – 检查项目模板维护

### 3.1 URL
`/inspection/template`

### 3.2 列表
- 列：模板名称、适用场景、项目数、创建人、更新时间、操作。
- 支持导入（Excel）、导出、批量删除。

### 3.3 模板编辑 (D_TemplateEdit)
- 左侧：项目树（支持拖拽排序）
- 右侧：项目属性表单
  - 项目名称
  - 数据类型（数值/文本/布尔/枚举）
  - 单位（选数值时必选）
  - 规格上限、下限（数值时）
  - 默认值
  - 是否必填
  - 拍照要求（是/否）
  - 备注提示
- 保存即版本化，旧版本保留。

---

## 4. P_Plan – 点检计划管理

### 4.1 URL
`/inspection/plan`

### 4.2 列表
- 列：计划名称、策略名称、设备范围、周期、下次执行时间、状态、操作。
- 状态：草稿、已发布、已停用、已完成。
- 操作：发布/停用、编辑、复制、删除（仅草稿可删）。

### 4.3 计划创建向导 (D_PlanWizard)
| 步骤 | 内容 |
|---|---|
| 1 选择策略 | 单选，自动带出策略关联的模板 |
| 2 设置周期 | 支持日历式、班次数、循环次数 |
| 3 选择设备 | 树形多选（线体→设备→型号） |
| 4 设定提醒 | 提前 N 分钟/小时/天，通道多选（看板、声光、APP、微信、邮件） |
| 5 审核人 | 可选，开启时需审核后才生成任务 |

发布逻辑：
- 立即生成从生效日期开始的全部任务 → 表 `inspection_task`
- 状态 `Pending`，推送首次提醒。

---

## 5. P_Task – 点检任务列表

### 5.1 URL
`/inspection/task`

### 5.2 视图切换
- 列表视图（默认）
- 甘特视图（按天/周/月）
- 卡片视图（移动端优先）

### 5.3 列表字段
任务号、设备编码、设备名称、任务类型、计划时间、执行人、状态、操作。

### 5.4 状态机
```
Pending -> InProgress -> Completed
            ↓
        Cancelled
```
异常分支：
```
InProgress -> Abnormal -> Processing -> Resolved -> Closed
```

### 5.5 筛选区
- 时间段
- 设备/线体/型号
- 执行人
- 状态
- 异常标记

### 5.6 批量操作
- 批量指派执行人
- 批量延期
- 批量关闭（仅 Abnormal Resolved）

---

## 6. P_Execute – 点检执行页

### 6.1 URL
`/inspection/execute/:taskId`

### 6.2 页面区域
1. **任务信息卡**  
   设备、计划时间、剩余时间倒计时。
2. **检查表**  
   动态渲染字段，支持：
  - 数值输入（自动带出单位、上下限提示）
  - 枚举下拉
  - 开关/复选框
  - 拍照（调用摄像头/相册，限制 5M）
3. **参数自动获取区**  
   若策略开启「自动读取」：
  - 通过 OPC UA / MQTT 实时读取设备当前值
  - 显示差异（当前值 vs 标准值）
4. **异常上报**
  - 一键异常按钮（红色）
  - 弹窗 D_ReportAbnormal
    - 异常类型（下拉）
    - 异常描述（必填）
    - 拍照（最多 3 张）
    - 声音录音（可选）
5. **提交**
  - 校验所有必填项
  - 提交后 → 任务状态 `Completed` 或 `Abnormal`
  - 推送结果到看板和邮件

---

## 7. P_Abnormality – 异常管理中心

### 7.1 URL
`/inspection/abnormality`

### 7.2 列表
- 列：异常单号、任务号、设备、异常类型、发现人、发现时间、状态、当前处理人、操作。
- 状态：待处理、处理中、待审核、已关闭。
- 支持快速筛选「我的待处理」。

### 7.3 详情页 (P_AbnormalityDetail)
- 上半：异常快照（图片、描述、发现时间）
- 中部：处理记录时间轴
  - 处理人、处理动作、备注、附件
- 下部：审核区（仅审核人可见）
  - 审核结果（通过/退回）
  - 审核意见
- 右侧：设备实时数据面板（只读）

---

## 8. P_Report – 报表中心

### 8.1 URL
`/inspection/report`

### 8.2 报表列表
| 报表名称 | 维度 | 指标 | 图表类型 | 导出格式 |
|---|---|---|---|---|
| 任务完成率 | 日/周/月/线体/设备 | 完成率、准时率 | 折线/柱状 | Excel、PDF |
| 异常分析 | 异常类型/设备/时间 | 次数、关闭时长 | 饼图、TOP10 | Excel |
| 点检效率 | 执行人 | 人均任务数、平均时长 | 条形 | Excel |
| 参数趋势 | 数值型项目 | 平均值、最大值、最小值 | 折线 | Excel、CSV |

### 8.3 自定义报表 (D_CustomReport)
- 拖拽字段
- 自定义 SQL（高级用户）
- 保存为模板

---

## 9. P_SystemConfig – 系统设置

### 9.1 URL
`/inspection/config`

### 9.2 设置分组
1. **消息推送**
  - 通道启用/禁用
  - 模板变量（任务号、设备名、异常描述…）
  - 频率限制（同一任务最多每 30 分钟 1 次）
2. **权限管理**
  - 角色与功能矩阵（表格）
  - 数据范围规则（按线体、型号）
3. **单位换算表**
  - 源单位 → 目标单位 → 系数（可导入 Excel）
4. **接口配置**
  - MES 地址、OPC UA 节点配置、Token
5. **日志与监控**
  - 登录日志、接口耗时、推送失败重试策略

---

## 10. 移动端专页 (M_Execute)

### 10.1 入口
`/inspection/m/execute/:taskId`

### 10.2 适配
- 底部大按钮「扫码开始」「提交」「异常」
- 离线缓存：任务数据本地存储，网络恢复后自动同步
- 拍照压缩至 800×600，上传前二次压缩

---

## 11. 组件索引（供 AI 快速索引）
| 组件名 | 用途 | 主要 Props |
|---|---|---|
| C_FilterBar | 通用筛选栏 | filters: object |
| C_KpiCard | 指卡片 | title, value, unit, trend |
| C_Chart_CompletionRate | 完成率趋势 | mode, dateRange |
| C_Table_TopAbnormal | 异常排行榜 | limit |
| D_CreatePolicy | 策略新建弹窗 | onSuccess |
| D_ReportAbnormal | 异常上报弹窗 | taskId |
| C_ParamReader | 实时参数读取 | deviceId |

---

## 12. 数据模型（核心字段）
```json
// inspection_task
{
  id: UUID,
  plan_id: UUID,
  device_id: UUID,
  scheduled_time: datetime,
  executor_id: UUID,
  status: enum,
  result_data: JSON, // 各项目值
  abnormal_id: UUID|null
}

// inspection_policy
{
  id: UUID,
  name: string,
  scene: enum,
  template_id: UUID,
  rules: JSON, // 上下限、单位换算
  filters: JSON // 设备型号、线体
}
```

---

## 13. 非功能性要求
- **并发**：1000 台设备同时在线轮询，<2s 延迟。
- **离线**：移动端离线 8 小时内数据不丢失。
- **安全**：敏感接口加签，图片上传鉴权。
- **国际化**：文案全部抽取到 `locales/inspection.json`。

---

以上即为设备点巡检管理模块的全部页面级需求。  

